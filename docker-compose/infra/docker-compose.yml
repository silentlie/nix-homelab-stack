services:
  # Technitium DNS server
  technitium:
    image: technitium/dns-server:latest
    container_name: technitium
    ports:
      - "53:53/udp"
      - "53:53/tcp"
      - "853:853/tcp"   # DoT
      - "853:853/udp"   # DoQ
    networks:
      - homelab
    volumes:
      - ./technitium:/etc/dns
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:5380/"]
      interval: 10s
      timeout: 3s
      retries: 10
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Traefik reverse proxy (internet traffic)
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "192.168.1.20:80:80"
      - "192.168.1.20:443:443"
    networks:
      - homelab
    depends_on:
      authentik:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/acme.json:/etc/traefik/acme.json
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx reverse proxy (LAN traffic)
  nginx:
    image: nginx:alpine
    container_name: nginx
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/snippets:/etc/nginx/snippets:ro
      - ./vault/agent/certs:/etc/nginx/certs:ro
    ports:
      - "192.168.1.21:80:80"
      - "192.168.1.21:443:443"
    networks:
      - homelab
    depends_on:
      vault-agent:
        condition: service_healthy
      authentik:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Primary Vault
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    command: vault server -config=/vault/config
    depends_on:
      vault-transit:
        condition: service_healthy
    volumes:
      - ./vault/primary/file:/vault/file
      - ./vault/primary/config:/vault/config:ro
      - ./vault/primary/policies:/vault/policies:ro
    networks:
      - homelab
      - transit
      - agent
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
      - CHOWN
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD", "sh", "-c", "vault status -format=json >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Vault Agent (per-host sidecar)
  vault-agent:
    image: hashicorp/vault:latest
    container_name: vault-agent
    command: vault agent -config=/vault/agent/agent.hcl
    depends_on:
      vault:
        condition: service_healthy
    volumes:
      - ./vault/agent/agent.hcl:/vault/agent/agent.hcl:ro
      - ./vault/agent:/vault/agent
      - ./vault/agent/certs:/vault/certs
      - postgres_secrets:/vault/postgres
    networks:
      - agent
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
    healthcheck:
      test: ["CMD-SHELL", "test -s /vault/postgres/001-init.sql"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Central PostgreSQL Database
  postgres:
    image: postgres:latest
    container_name: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_secrets:/docker-entrypoint-initdb.d:ro
    networks:
      - homelab
    depends_on:
      vault-agent:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Authentik (authentication)
  authentik:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik
    command: server
    environment:
      AUTHENTIK_REDIS__HOST: redis.home.arpa
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__USER: ${POSTGRES_USER:-postgres}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${POSTGRES_PASSWORD:?error}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?error}
    ports:
      - "9000:9000"
      - "9443:9443"
    depends_on:
      - postgres
    volumes:
      - authentik_media:/media
    networks:
      - homelab
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # Vaultwarden (Bitwarden alternative)
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:?error}@postgres:5432/vaultwarden
      DOMAIN: ${VAULTWARDEN_DOMAIN:-https://vaultwarden.home.arpa}
      SHOW_PASSWORD_HINT: "false"
      INVITATIONS_ORG_INVITE_EXPIRATION_HOURS: 24
    volumes:
      - vaultwarden_data:/data
    ports:
      - "8000:80"
    depends_on:
      - postgres
    networks:
      - homelab
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/alive"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  homelab:
    driver: bridge
  transit:
    driver: bridge
    external: true
  agent:
    driver: bridge

volumes:
  postgres_data:
  postgres_secrets:
  authentik_media:
  vaultwarden_data:
