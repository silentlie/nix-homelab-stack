services:
  # Technitium DNS server
  technitium:
    image: technitium/dns-server:latest
    container_name: technitium
    ports:
      - "53:53/udp"
      - "53:53/tcp"
      - "853:853/tcp"   # DoT
      - "853:853/udp"   # DoQ
    networks:
      - homelab
    # depends_on:
    #   vault-agent-openssl:
    #     condition: service_healthy
    volumes:
      - ./technitium:/etc/dns
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:5380/"]
      interval: 10s
      timeout: 3s
      retries: 10
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Traefik reverse proxy (internet traffic)
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "192.168.1.20:80:80"
      - "192.168.1.20:443:443"
    networks:
      - homelab
    depends_on:
      authentik:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/acme.json:/etc/traefik/acme.json
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx reverse proxy (local traffic)
  nginx:
    image: nginx:alpine
    container_name: nginx
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/snippets:/etc/nginx/snippets:ro
      - ./vault/agent/file/certs:/etc/nginx/certs:ro
    ports:
      - "192.168.1.21:80:80"
      - "192.168.1.21:443:443"
    networks:
      - homelab
    depends_on:
      vault-agent:
        condition: service_healthy
      # authentik:
      #   condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Primary Vault
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    command: vault server -config=/vault/config
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
    volumes:
      - ./vault/primary/file:/vault/file
      - ./vault/primary/config:/vault/config:ro
      - ./vault/primary/policies:/vault/policies:ro
    ports:
      - "127.0.0.1:8200:8200"
    networks:
      - homelab
      - transit
      - agent
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
      - CHOWN
      - SETFCAP
      - SETGID
      - SETUID
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD", "sh", "-c", "vault status -format=json >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Vault Agent (per-host sidecar)
  vault-agent:
    image: hashicorp/vault:latest
    container_name: vault-agent
    command: vault agent -config=/vault/agent/agent.hcl
    depends_on:
      vault:
        condition: service_healthy
    volumes:
      - ./vault/agent/agent.hcl:/vault/agent/agent.hcl:ro
      - ./vault/agent/templates:/vault/agent/templates:ro
      - ./vault/agent/file:/vault/file
      # - redis_secrets:/vault/file/redis
    networks:
      - agent
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
      - CHOWN
      - SETFCAP
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD-SHELL", "test -s /vault/file/postgres/001-init.sql"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  vault-agent-openssl:
    image: alpine:latest
    container_name: vault-agent-openssl
    command: >
      sh -c "
        apk add --no-cache bash openssl dcron;
        echo 'Setting up cron job to run every hour...';
        echo '0 * * * * /bin/sh -c \"echo Removing old dns.pfx... && rm -f /technitium/dns.pfx && echo Generating dns.pfx... && openssl pkcs12 -export -out /technitium/dns.pfx -inkey /certs/dns.key -in /certs/dns-crt.pem -certfile /certs/ca-chain.pem -passout pass: && echo Generated dns.pfx at /technitium/dns.pfx\"' > /etc/crontabs/root;
        echo 'Starting cron service...';
        crond -f;
      "
    depends_on:
      vault-agent:
        condition: service_healthy
    volumes:
      - ./vault/agent/file/certs:/certs
      - ./technitium:/technitium
    restart: no
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "test -s /technitium/dns.pfx"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 0s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Central PostgreSQL Database
  postgres:
    image: postgres:latest
    container_name: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./vault/agent/file/postgres:/docker-entrypoint-initdb.d:ro
    networks:
      - db
    depends_on:
      vault-agent:
        condition: service_healthy
    env_file:
      - ./vault/agent/file/postgres/postgres.env
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # redis:
  #   image: redis:latest
  #   container_name: redis
  #   command: >
  #     redis-server /redis.conf
  #   depends_on:
  #     vault-agent:
  #       condition: service_healthy
  #   volumes:
  #     - redis_data:/data
  #     - redis_secrets:/secrets:ro
  #     - ./redis/redis.conf:/redis.conf:ro
  #   restart: unless-stopped
  #   security_opt:
  #     - no-new-privileges:true
  #   cap_drop:
  #     - ALL
  #   healthcheck:
  #     test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 ping | grep -q PONG"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 10
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

  # Authentik (authentication)
  authentik:
    image: authentik/server:2025.10.3
    container_name: authentik
    command: server
    depends_on:
      vault-agent:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - ./vault/agent/file/authentik/authentik.env
    networks:
      - homelab
      - db
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:9000/-/health/ready/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  authentik-worker:
    image: authentik/server:2025.10.3
    command: worker
    env_file:
      - ./vault/agent/file/authentik/authentik.env
    depends_on:
      authentik:
        condition: service_healthy
    networks:
        - db
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:9000/-/health/ready/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Vaultwarden
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    volumes:
      - vaultwarden_data:/data
    depends_on:
      postgres:
        condition: service_healthy
      vault-agent:
        condition: service_healthy
    env_file:
      - ./vault/agent/file/vaultwarden/vaultwarden.env
    networks:
      - homelab
      - db
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://127.0.0.1:80/alive"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  homelab:
    driver: bridge
  transit:
    driver: bridge
    external: true
  agent:
    driver: bridge
  db:
    driver: bridge
    internal: true

volumes:
  postgres_data:
  # redis_data:
  # redis_secrets:
  vaultwarden_data:
