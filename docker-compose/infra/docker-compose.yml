version: '3.8'

services:
  # Technitium DNS server
  technitium:
    image: technitiumdns/dns-server:latest
    container_name: technitium
    ports:
      - "${DNS_PORT:-53}:53/udp"
      - "${DNS_PORT:-53}:53/tcp"
      - "${TECHNITIUM_UI_PORT:-5380}:5380/tcp"
    volumes:
      - technitium_config:/etc/technitiumdns/config
    networks:
      - homelab
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://+:5380

  # Traefik reverse proxy (external traffic)
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme.json"
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik_acme:/
      - traefik_config:/etc/traefik
    networks:
      - homelab
    restart: unless-stopped

  # Nginx reverse proxy (internal traffic)
  nginx:
    image: nginx:alpine
    container_name: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_config:/etc/nginx
    ports:
      - "${NGINX_PORT:-8081}:80"
    networks:
      - homelab
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HashiCorp Vault (secrets management)
  vault:
    image: vault:latest
    container_name: vault
    command: vault server -config=/vault/config/vault.json
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://vault:8200
      VAULT_SKIP_VERIFY: "true"
    volumes:
      - vault_data:/vault/file
      - ./vault-config.json:/vault/config/vault.json:ro
    ports:
      - "${VAULT_PORT:-8200}:8200"
    networks:
      - homelab
    restart: unless-stopped
    cap_add:
      - IPC_LOCK

  # Authentik (authentication)
  authentik-db:
    image: postgres:15-alpine
    container_name: authentik-db
    environment:
      POSTGRES_DB: authentik
      POSTGRES_USER: ${AUTHENTIK_DB_USER:-authentik}
      POSTGRES_PASSWORD: ${AUTHENTIK_DB_PASSWORD:?error}
    volumes:
      - authentik_db:/var/lib/postgresql/data
    networks:
      - homelab
    restart: unless-stopped

  authentik-server:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-server
    command: server
    environment:
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_POSTGRESQL__HOST: authentik-db
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_DB_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_DB_PASSWORD:?error}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?error}
    ports:
      - "${AUTHENTIK_PORT:-9000}:9000"
      - "${AUTHENTIK_HTTPS_PORT:-9443}:9443"
    depends_on:
      - authentik-db
    volumes:
      - authentik_media:/media
    networks:
      - homelab
    restart: unless-stopped

  # Vaultwarden (Bitwarden alternative)
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    environment:
      DATABASE_URL: ${VAULTWARDEN_DB_URL:?error}
      DOMAIN: ${VAULTWARDEN_DOMAIN:-https://vaultwarden.example.com}
      SHOW_PASSWORD_HINT: "false"
      INVITATIONS_ORG_INVITE_EXPIRATION_HOURS: 24
    volumes:
      - vaultwarden_data:/data
    ports:
      - "${VAULTWARDEN_PORT:-8000}:80"
    networks:
      - homelab
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/alive"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  homelab:
    driver: bridge

volumes:
  technitium_config:
  traefik_acme:
  traefik_config:
  nginx_config:
  vault_data:
  authentik_db:
  authentik_media:
  vaultwarden_data:
