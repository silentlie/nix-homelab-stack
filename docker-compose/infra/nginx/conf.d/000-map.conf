map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

map $http_upgrade $connection_upgrade_keepalive {
    default upgrade;
    ''      '';
}

# Rate limiting zone (10 requests/second per IP)
limit_req_zone $binary_remote_addr zone=default_limit:10m rate=10r/s;
limit_req_log_level warn;

# Connection limiting zone (max concurrent connections per IP)
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn_log_level warn;